{% extends "base.html" %}
{% block head_title %}{{ review.title }} | {{ block.super }}{% endblock head_title %}
{% load bootstrap3 %}
{% block content %}


{% with total_likes=review.users_like.count users_like=review.users_like.all %}
<div class="container">
<div class="row">
  <div class="well col-xs-12 col-md-12">
    <div class="thumbnail">
      {% if review.photo %}
      <img class="img-responsive img-rounded strain-photo" src="{{ review.photo.url }}"/>
      {% else %}
      <img class="img-responsive img-rounded strain-photo" src="https://www.placehold.it/300x300"/>
      {% endif %}
      <div class="caption">
        {% load rating_icon %}
        <h1>{{review.rating|rating_icon}}</h1>
        <h1>{{ review.title }}</h1>
        <h3><a href="{{ review.strain.get_absolute_url }}">{{ review.strain }}</a> {{ review.method|lower }}</h3>
        <p>{{ review.content }}</p>
        <p>Reviewd by <a href="{% url 'accounts:user' review.user.username %}">{{ review.user }}</a></p>
        <p>Last Update: {{ review.updated }}</p>
      </div> <!--/.caption-->
      <span class="count">
        <span class="total">{{ total_likes }}</span>
        Like{{ total_likes|pluralize }}
      </span>
      <a href="#" data-id="{{ review.id }}" data-action="{% if request.user in users_like %}un{% endif %}like" class="like button">
        {% if request.user not in users_like %}
          Like
        {% else %}
          Unlike
        {% endif %}
      </a>
      {% endwith %}

    </div> <!--/.thumbnail-->
  </div> <!--/.well.col-xs-12.col-lg-6-->
</div> <!--/.row-->
<div class="row">
  <div class="col-xs-12">
    {% with comments.count as total_comments %}
    <h2>
      {{ total_comments }} comment{{ total_comments|pluralize }}
    </h2>

    {% for comment in comments %}
    <p> Comment {{ forloop.counter }} by @{{comment.name}} {{comment.created}}</p>
    <p>{{ comment.body|linebreaks }}</p>
    {% empty %}
    <p>There are no comments yet.</p>
    {% endfor %}
    {% if new_comment %}
    <h2>Your comment has been added.</h2>
    {% else %}
    <h2>Add a new comment</h2>
    <form action="." method="post">
      {% csrf_token %}
      {% bootstrap_form comment_form layout='inline' %}
      {% buttons %}
      <button type=submit class="btn btn-default">
        {% bootstrap_icon "star" %} Comment
      </button>
      {% endbuttons %}
    </form>
  </div>
</div>
</div> <!--/.container-->
{% endif %}
{% endwith %}
{% endblock %}


 {% block domready %}
      $('a.like').click(function(e){
       e.preventDefault();
       $.post('{% url "reviews:like" %}',
         {
           id: $(this).data('id'),
           action: $(this).data('action')
         },
         function(data){
           if (data['status'] == 'ok')
           {
             var previous_action = $('a.like').data('action');
             // toggle data-action
             $('a.like').data('action', previous_action == 'like' ? 'unlike' : 'like');

// toggle link text
$('a.like').text(previous_action == 'like' ? 'Unlike' : 'Like');




             // update total likes
var previous_likes = parseInt($('span.count .total').text());
$('span.count .total').text(previous_action == 'like' ? previous_likes + 1 : previous_likes - 1);
}

});
});
   {% endblock %}
